<!DOCTYPE html>
<html lang=big5>
<head>
<meta charset=utf-8>
<title>MQTT IoT裝置模擬器:JSON</title>
<style>.scrollable-div{height:200px;overflow:auto;border:1px solid #ccc}</style>
</head>
<body>
<h1>MQTT IoT裝置模擬器 : JSON</h1>
<form id=mqttForm>
<label for=brokerHost>Broker主機：</label>
<input type=text id=brokerHost required value=broker.hivemq.com> &nbsp; &nbsp;
<label for=brokerPort>埠號：</label>
<input type=text id=brokerPort required value=8000><br><br>
<button type=button onclick=connectBroker()>連線至MQTT Broker</button> <small><span id=client_id></span></small><br><br>
<label for=mqttTopic>MQTT主題：</label>
<input type=text id=mqttTopic required value=sensors/livingroom><br><br>
<label for=key>鍵名(1)：</label>
<input type=text id=key placeholder=輸入鍵名 value=temp> &nbsp; &nbsp;
<label for=minValue>最小值：</label>
<input type=number id=minValue placeholder=輸入最小值 value=25> &nbsp; &nbsp;
<label for=maxValue>最大值：</label>
<input type=number id=maxValue placeholder=輸入最大值 value=55><br><br>
<label for=key2>鍵名(2)：</label>
<input type=text id=key2 placeholder=輸入鍵名 value=humidity> &nbsp; &nbsp;
<label for=minValue2>最小值：</label>
<input type=number id=minValue2 placeholder=輸入最小值 value=65> &nbsp; &nbsp;
<label for=maxValue2>最大值：</label>
<input type=number id=maxValue2 placeholder=輸入最大值 value=95><br><br>
<label for=tofix>取小數點下幾位數, 0 是取整數：</label>
<input type=number id=tofix required value=0><br><br>
<label for=publishInterval>出版間隔時間（毫秒）：</label>
<input type=number id=publishInterval required value=3000><br><br>
<button type=button onclick=startPublishing()>開始出版訊息</button>
<button type=button onclick=stopPublishing()>停止出版訊息</button>
</form><br>
<div id=status style=color:red></div><br>
<div id=output style=color:blue class=scrollable-div></div>
<script>var mqttClient;var isConnected=false;var timer;function generateClientID(){var b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";var f=new Date().getTime();var c=f;var d="";for(var e=0;e<15;e++){c=(c*9301+49297)%233280;var a=Math.floor(c/233280*b.length);d+=b.charAt(a)}return d}function connectBroker(){var b=document.getElementById("brokerHost").value;var c=Number(document.getElementById("brokerPort").value);var a=generateClientID();document.getElementById("client_id").innerHTML="<b>Client Id: </b>"+a;mqttClient=new Messaging.Client(b,c,a);mqttClient.onConnectionLost=onConnectionLost;mqttClient.connect({onSuccess:onConnect})}function onConnect(){isConnected=true;document.getElementById("status").innerHTML="成功連線至Broker";document.getElementById("output").innerHTML=""}function onConnectionLost(a){if(a.errorCode!==0){isConnected=false;document.getElementById("status").innerHTML="連線失敗: "+a.errorMessage}}function startPublishing(){if(!isConnected){document.getElementById("status").innerHTML="請先連線至Broker";return}var d=document.getElementById("mqttTopic").value;var i=Number(document.getElementById("publishInterval").value);var a=Number(document.getElementById("tofix").value);var g=document.getElementById("key").value;var e=Number(document.getElementById("minValue").value);var b=Number(document.getElementById("maxValue").value);var f=document.getElementById("key2").value;var h=Number(document.getElementById("minValue2").value);var c=Number(document.getElementById("maxValue2").value);timer=setInterval(function(){var l=new Date();if(isConnected){var m=Math.random()*(b-e+1)+e;var k=Math.random()*(c-h+1)+h;var j="";if(a==0){j='{"'+g+'":'+Math.floor(m).toString()+',"'+f+'":'+Math.floor(k).toString()+"}"}else{j='{"'+g+'":'+m.toFixed(a).toString()+',"'+f+'":'+k.toFixed(a).toString()+"}"}var n=new Messaging.Message(j);n.destinationName=d;mqttClient.send(n);document.getElementById("output").innerHTML+=l.toLocaleString()+" -> 主題: "+d+"，訊息: "+j+"<br>";var o=document.querySelector(".scrollable-div");o.scrollTop=o.scrollHeight}},i)}function stopPublishing(){clearInterval(timer);document.getElementById("output").innerHTML+="出版MQTT訊息已停止。<br>";mqttClient.disconnect();isConnected=false;document.getElementById("status").innerHTML="已經中斷連線Broker";var a=document.querySelector(".scrollable-div");a.scrollTop=a.scrollHeight}</script>
<script>Messaging=(function(q){var f="0.0.0.0";var i="@BUILDLEVEL@";var m={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14};var k=function(A,z){for(key in A){if(A.hasOwnProperty(key)){if(z.hasOwnProperty(key)){if(typeof A[key]!==z[key]){throw new Error(t(h.INVALID_TYPE,[typeof A[key],key]))}}else{var y="Unknown property, "+key+". Valid properties are:";for(key in z){if(z.hasOwnProperty(key)){y=y+" "+key}}throw new Error(y)}}}};var b=function(z,y){return function(){return z.apply(y,arguments)}};var h={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error."},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}};var d={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"};var t=function(y,A){var D=y.text;if(A){for(var z=0;z<A.length;z++){field="{"+z+"}";start=D.indexOf(field);if(start>0){var C=D.substring(0,start);var B=D.substring(start+field.length);D=C+A[z]+B}}}return D};var n=[0,6,77,81,73,115,100,112,3];var p=function(z,y){this.type=z;for(name in y){if(y.hasOwnProperty(name)){this[name]=y[name]}}};p.prototype.encode=function(){var E=((this.type&15)<<4);remLength=0;topicStrLength=new Array();if(this.messageIdentifier!=undefined){remLength+=2}switch(this.type){case m.CONNECT:remLength+=n.length+3;remLength+=c(this.clientId)+2;if(this.willMessage!=undefined){remLength+=c(this.willMessage.destinationName)+2;var z=this.willMessage.payloadBytes;if(!(z instanceof Uint8Array)){z=new Uint8Array(C)}remLength+=z.byteLength+2}if(this.userName!=undefined){remLength+=c(this.userName)+2}if(this.password!=undefined){remLength+=c(this.password)+2}break;case m.SUBSCRIBE:E|=2;for(var D=0;D<this.topics.length;D++){topicStrLength[D]=c(this.topics[D]);remLength+=topicStrLength[D]+2}remLength+=this.requestedQos.length;break;case m.UNSUBSCRIBE:E|=2;for(var D=0;D<this.topics.length;D++){topicStrLength[D]=c(this.topics[D]);remLength+=topicStrLength[D]+2}break;case m.PUBLISH:if(this.payloadMessage.duplicate){E|=8}E=E|=(this.payloadMessage.qos<<1);if(this.payloadMessage.retained){E|=1}destinationNameLength=c(this.payloadMessage.destinationName);remLength+=destinationNameLength+2;var C=this.payloadMessage.payloadBytes;remLength+=C.byteLength;if(C instanceof ArrayBuffer){C=new Uint8Array(C)}else{if(!(C instanceof Uint8Array)){C=new Uint8Array(C.buffer)}}break;case m.DISCONNECT:break;default:}var y=w(remLength);var F=y.length+1;var A=new ArrayBuffer(remLength+F);var G=new Uint8Array(A);G[0]=E;G.set(y,1);if(this.type==m.PUBLISH){F=s(this.payloadMessage.destinationName,destinationNameLength,G,F)}else{if(this.type==m.CONNECT){G.set(n,F);F+=n.length;var B=0;if(this.cleanSession){B=2}if(this.willMessage!=undefined){B|=4;B|=(this.willMessage.qos<<3);if(this.willMessage.retained){B|=32}}if(this.userName!=undefined){B|=128}if(this.password!=undefined){B|=64}G[F++]=B;F=x(this.keepAliveInterval,G,F)}}if(this.messageIdentifier!=undefined){F=x(this.messageIdentifier,G,F)}switch(this.type){case m.CONNECT:F=s(this.clientId,c(this.clientId),G,F);if(this.willMessage!=undefined){F=s(this.willMessage.destinationName,c(this.willMessage.destinationName),G,F);F=x(z.byteLength,G,F);G.set(z,F);F+=z.byteLength}if(this.userName!=undefined){F=s(this.userName,c(this.userName),G,F)}if(this.password!=undefined){F=s(this.password,c(this.password),G,F)}break;case m.PUBLISH:G.set(C,F);break;case m.SUBSCRIBE:for(var D=0;D<this.topics.length;D++){F=s(this.topics[D],topicStrLength[D],G,F);G[F++]=this.requestedQos[D]}break;case m.UNSUBSCRIBE:for(var D=0;D<this.topics.length;D++){F=s(this.topics[D],topicStrLength[D],G,F)}break;default:}return A};function e(G){var A=G[0];var C=A>>4;var y=A&=15;var D=1;var E;var F=0;var J=1;do{E=G[D++];F+=((E&127)*J);J*=128}while((E&128)!=0);var H=new p(C);switch(C){case m.CONNACK:H.topicNameCompressionResponse=G[D++];H.returnCode=G[D++];break;case m.PUBLISH:var I=(y>>1)&3;var B=j(G,D);D+=2;var z=l(G,D,B);D+=B;if(I>0){H.messageIdentifier=j(G,D);D+=2}var K=new Messaging.Message(G.subarray(D));if((y&1)==1){K.retained=true}if((y&8)==8){K.duplicate=true}K.qos=I;K.destinationName=z;H.payloadMessage=K;break;case m.PUBACK:case m.PUBREC:case m.PUBREL:case m.PUBCOMP:case m.UNSUBACK:H.messageIdentifier=j(G,D);break;case m.SUBACK:H.messageIdentifier=j(G,D);D+=2;H.grantedQos=G.subarray(D);break;default:}return H}function x(z,y,A){y[A++]=z>>8;y[A++]=z%256;return A}function s(z,A,y,B){B=x(A,y,B);g(z,y,B);return B+A}function j(y,z){return 256*y[z]+y[z+1]}function w(A){var y=new Array(1);var z=0;do{var B=A%128;A=A>>7;if(A>0){B|=128}y[z++]=B}while((A>0)&&(z<4));return y}function c(A){var z=0;for(var B=0;B<A.length;B++){var y=A.charCodeAt(B);if(y>2047){if(55296<=y&&y<=56319){B++;z++}z+=3}else{if(y>127){z+=2}else{z++}}}return z}function g(A,z,D){var C=D;for(var B=0;B<A.length;B++){var y=A.charCodeAt(B);if(55296<=y&&y<=56319){lowCharCode=A.charCodeAt(++B);if(isNaN(lowCharCode)){throw new Error(t(h.MALFORMED_UNICODE,[y,lowCharCode]))}y=((y-55296)<<10)+(lowCharCode-56320)+65536}if(y<=127){z[C++]=y}else{if(y<=2047){z[C++]=y>>6&31|192;z[C++]=y&63|128}else{if(y<=65535){z[C++]=y>>12&15|224;z[C++]=y>>6&63|128;z[C++]=y&63|128}else{z[C++]=y>>18&7|240;z[C++]=y>>12&63|128;z[C++]=y>>6&63|128;z[C++]=y&63|128}}}}return z}function l(F,B,y){var z="";var A;var D=B;while(D<B+y){var H=F[D++];if(H<128){A=H}else{var G=F[D++]-128;if(G<0){throw new Error(t(h.MALFORMED_UTF,[H.toString(16),G.toString(16),""]))}if(H<224){A=64*(H-192)+G}else{var E=F[D++]-128;if(E<0){throw new Error(t(h.MALFORMED_UTF,[H.toString(16),G.toString(16),E.toString(16)]))}if(H<240){A=4096*(H-224)+64*G+E}else{var C=F[D++]-128;if(C<0){throw new Error(t(h.MALFORMED_UTF,[H.toString(16),G.toString(16),E.toString(16),C.toString(16)]))}if(H<248){A=262144*(H-240)+4096*G+64*E+C}else{throw new Error(t(h.MALFORMED_UTF,[H.toString(16),G.toString(16),E.toString(16),C.toString(16)]))}}}}if(A>65535){A-=65536;z+=String.fromCharCode(55296+(A>>10));A=56320+(A&1023)}z+=String.fromCharCode(A)}return z}var r=function(y,D,C){this._client=y;this._window=D;this._keepAliveInterval=C*1000;this.isReset=false;var B=new p(m.PINGREQ).encode();var A=function(E){return function(){return z.apply(E)}};var z=function(){if(!this.isReset){this._client._trace("Pinger.doPing","Timed out");this._client._disconnected(h.PING_TIMEOUT.code,t(h.PING_TIMEOUT))}else{this.isReset=false;this._client._trace("Pinger.doPing","send PINGREQ");this._client.socket.send(B);this.timeout=this._window.setTimeout(A(this),this._keepAliveInterval)}};this.reset=function(){this.isReset=true;this._window.clearTimeout(this.timeout);if(this._keepAliveInterval>0){this.timeout=setTimeout(A(this),this._keepAliveInterval)}};this.cancel=function(){this._window.clearTimeout(this.timeout)}};var v=function(y,C,A,D,z){this._window=C;if(!A){A=30}var B=function(G,E,F){return function(){return G.apply(E,F)}};this.timeout=setTimeout(B(D,y,z),A*1000);this.cancel=function(){this._window.clearTimeout(this.timeout)}};var u=function(A,z,y){if(!("WebSocket" in q&&q.WebSocket!==null)){throw new Error(t(h.UNSUPPORTED,["WebSocket"]))}if(!("localStorage" in q&&q.localStorage!==null)){throw new Error(t(h.UNSUPPORTED,["localStorage"]))}if(!("ArrayBuffer" in q&&q.ArrayBuffer!==null)){throw new Error(t(h.UNSUPPORTED,["ArrayBuffer"]))}this._trace("Messaging.Client",A,z,y);this.host=A;this.port=z;this.clientId=y;this._localKey=A+":"+z+":"+y+":";this._msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(key in localStorage){if(key.indexOf("Sent:"+this._localKey)==0||key.indexOf("Received:"+this._localKey)==0){this.restore(key)}}};u.prototype.host;u.prototype.port;u.prototype.clientId;u.prototype.socket;u.prototype.connected=false;u.prototype.maxMessageIdentifier=65536;u.prototype.connectOptions;u.prototype.hostIndex;u.prototype.onConnectionLost;u.prototype.onMessageDelivered;u.prototype.onMessageArrived;u.prototype._msg_queue=null;u.prototype._connectTimeout;u.prototype.sendPinger=null;u.prototype.receivePinger=null;u.prototype._traceBuffer=null;u.prototype._MAX_TRACE_ENTRIES=100;u.prototype.connect=function(z){var y=this._traceMask(z,"password");this._trace("Client.connect",y,this.socket,this.connected);if(this.connected){throw new Error(t(h.INVALID_STATE,["already connected"]))}if(this.socket){throw new Error(t(h.INVALID_STATE,["already connected"]))}this.connectOptions=z;if(z.hosts){this.hostIndex=0;this._doConnect(z.hosts[0],z.ports[0])}else{this._doConnect(this.host,this.port)}};u.prototype.subscribe=function(z,y){this._trace("Client.subscribe",z,y);if(!this.connected){throw new Error(t(h.INVALID_STATE,["not connected"]))}var A=new p(m.SUBSCRIBE);A.topics=[z];if(y.qos!=undefined){A.requestedQos=[y.qos]}else{A.requestedQos=[0]}if(y.onSuccess){A.callback=function(){y.onSuccess({invocationContext:y.invocationContext})}}if(y.timeout){A.timeOut=new v(this,window,y.timeout,y.onFailure,[{invocationContext:y.invocationContext,errorCode:h.SUBSCRIBE_TIMEOUT.code,errorMessage:t(h.SUBSCRIBE_TIMEOUT)}])}this._requires_ack(A);this._schedule_message(A)};u.prototype.unsubscribe=function(z,y){this._trace("Client.unsubscribe",z,y);if(!this.connected){throw new Error(t(h.INVALID_STATE,["not connected"]))}var A=new p(m.UNSUBSCRIBE);A.topics=[z];if(y.onSuccess){A.callback=function(){y.onSuccess({invocationContext:y.invocationContext})}}if(y.timeout){A.timeOut=new v(this,window,y.timeout,y.onFailure,[{invocationContext:y.invocationContext,errorCode:h.UNSUBSCRIBE_TIMEOUT.code,errorMessage:t(h.UNSUBSCRIBE_TIMEOUT)}])}this._requires_ack(A);this._schedule_message(A)};u.prototype.send=function(y){this._trace("Client.send",y);if(!this.connected){throw new Error(t(h.INVALID_STATE,["not connected"]))}wireMessage=new p(m.PUBLISH);wireMessage.payloadMessage=y;if(y.qos>0){this._requires_ack(wireMessage)}else{if(this.onMessageDelivered){this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage)}}this._schedule_message(wireMessage)};u.prototype.disconnect=function(){this._trace("Client.disconnect");if(!this.socket){throw new Error(t(h.INVALID_STATE,["not connecting or connected"]))}wireMessage=new p(m.DISCONNECT);this._notify_msg_sent[wireMessage]=b(this._disconnected,this);this._schedule_message(wireMessage)};u.prototype.getTraceLog=function(){if(this._traceBuffer!==null){this._trace("Client.getTraceLog",new Date());this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(key in this._sentMessages){this._trace("_sentMessages ",key,this._sentMessages[key])}for(key in this._receivedMessages){this._trace("_receivedMessages ",key,this._receivedMessages[key])}return this._traceBuffer}};u.prototype.startTrace=function(){if(this._traceBuffer===null){this._traceBuffer=[]}this._trace("Client.startTrace",new Date(),f)};u.prototype.stopTrace=function(){delete this._traceBuffer};u.prototype._doConnect=function(z,y){if(this.connectOptions.useSSL){wsurl=["wss://",z,":",y,"/mqtt"].join("")}else{wsurl=["ws://",z,":",y,"/mqtt"].join("")}this.connected=false;this.socket=new WebSocket(wsurl,"mqttv3.1");this.socket.binaryType="arraybuffer";this.socket.onopen=b(this._on_socket_open,this);this.socket.onmessage=b(this._on_socket_message,this);this.socket.onerror=b(this._on_socket_error,this);this.socket.onclose=b(this._on_socket_close,this);this.sendPinger=new r(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new r(this,window,this.connectOptions.keepAliveInterval);this._connectTimeout=new v(this,window,this.connectOptions.timeout,this._disconnected,[h.CONNECT_TIMEOUT.code,t(h.CONNECT_TIMEOUT)])};u.prototype._schedule_message=function(y){this._msg_queue.push(y);if(this.connected){this._process_queue()}};u.prototype.store=function(C,B){storedMessage={type:B.type,messageIdentifier:B.messageIdentifier,version:1};switch(B.type){case m.PUBLISH:if(B.pubRecReceived){storedMessage.pubRecReceived=true}storedMessage.payloadMessage={};var A="";var z=B.payloadMessage.payloadBytes;for(var y=0;y<z.length;y++){if(z[y]<=15){A=A+"0"+z[y].toString(16)}else{A=A+z[y].toString(16)}}storedMessage.payloadMessage.payloadHex=A;storedMessage.payloadMessage.qos=B.payloadMessage.qos;storedMessage.payloadMessage.destinationName=B.payloadMessage.destinationName;if(B.payloadMessage.duplicate){storedMessage.payloadMessage.duplicate=true}if(B.payloadMessage.retained){storedMessage.payloadMessage.retained=true}if(C.indexOf("Sent:")==0){if(B.sequence===undefined){B.sequence=++this._sequence}storedMessage.sequence=B.sequence}break;default:throw Error(t(h.INVALID_STORED_DATA,[key,storedMessage]))}localStorage.setItem(C+this._localKey+B.messageIdentifier,JSON.stringify(storedMessage))};u.prototype.restore=function(G){var F=localStorage.getItem(G);var E=JSON.parse(F);var H=new p(E.type,E);switch(E.type){case m.PUBLISH:var y=E.payloadMessage.payloadHex;var z=new ArrayBuffer((y.length)/2);var C=new Uint8Array(z);var A=0;while(y.length>=2){var D=parseInt(y.substring(0,2),16);y=y.substring(2,y.length);C[A++]=D}var B=new Messaging.Message(C);B.qos=E.payloadMessage.qos;B.destinationName=E.payloadMessage.destinationName;if(E.payloadMessage.duplicate){B.duplicate=true}if(E.payloadMessage.retained){B.retained=true}H.payloadMessage=B;break;default:throw Error(t(h.INVALID_STORED_DATA,[G,F]))}if(G.indexOf("Sent:"+this._localKey)==0){this._sentMessages[H.messageIdentifier]=H}else{if(G.indexOf("Received:"+this._localKey)==0){this._receivedMessages[H.messageIdentifier]=H}}};u.prototype._process_queue=function(){var z=null;var y=this._msg_queue.reverse();while((z=y.pop())){this._socket_send(z);if(this._notify_msg_sent[z]){this._notify_msg_sent[z]();delete this._notify_msg_sent[z]}}};u.prototype._requires_ack=function(z){var y=Object.keys(this._sentMessages).length;if(y>this.maxMessageIdentifier){throw Error("Too many messages:"+y)}while(this._sentMessages[this._message_identifier]!==undefined){this._message_identifier++}z.messageIdentifier=this._message_identifier;this._sentMessages[z.messageIdentifier]=z;if(z.type===m.PUBLISH){this.store("Sent:",z)}if(this._message_identifier===this.maxMessagIdentifier){this._message_identifier=1}};u.prototype._on_socket_open=function(){var y=new p(m.CONNECT,this.connectOptions);y.clientId=this.clientId;this._socket_send(y)};u.prototype._on_socket_message=function(y){this._trace("Client._on_socket_message",y.data);this.receivePinger.reset();var z=new Uint8Array(y.data);try{var I=e(z)}catch(G){this._disconnected(h.INTERNAL_ERROR.code,t(h.INTERNAL_ERROR,[G.message]));return}this._trace("Client._on_socket_message",I);switch(I.type){case m.CONNACK:this._connectTimeout.cancel();if(this.connectOptions.cleanSession){for(key in this._sentMessages){var H=this._sentMessages[key];localStorage.removeItem("Sent:"+this._localKey+H.messageIdentifier)}this._sentMessages={};for(key in this._receivedMessages){var A=this._receivedMessages[key];localStorage.removeItem("Received:"+this._localKey+A.messageIdentifier)}this._receivedMessages={}}if(I.returnCode===0){this.connected=true;if(this.connectOptions.hosts){this.hostIndex=this.connectOptions.hosts.length}}else{this._disconnected(h.CONNACK_RETURNCODE.code,t(h.CONNACK_RETURNCODE,[I.returnCode,d[I.returnCode]]));break}var F=new Array();for(var B in this._sentMessages){if(this._sentMessages.hasOwnProperty(B)){F.push(this._sentMessages[B])}}var F=F.sort(function(K,J){return K.sequence-J.sequence});for(var D=0,E=F.length;D<E;D++){var H=F[D];if(H.type==m.PUBLISH&&H.pubRecReceived){var C=new p(m.PUBREL,{messageIdentifier:H.messageIdentifier});this._schedule_message(C)}else{this._schedule_message(H)}}if(this.connectOptions.onSuccess){this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext})}this._process_queue();break;case m.PUBLISH:this._receivePublish(I);break;case m.PUBACK:var H=this._sentMessages[I.messageIdentifier];if(H){delete this._sentMessages[I.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+I.messageIdentifier);if(this.onMessageDelivered){this.onMessageDelivered(H.payloadMessage)}}break;case m.PUBREC:var H=this._sentMessages[I.messageIdentifier];if(H){H.pubRecReceived=true;var C=new p(m.PUBREL,{messageIdentifier:I.messageIdentifier});this.store("Sent:",H);this._schedule_message(C)}break;case m.PUBREL:var A=this._receivedMessages[I.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+I.messageIdentifier);if(A){this._receiveMessage(A);delete this._receivedMessages[I.messageIdentifier]}pubCompMessage=new p(m.PUBCOMP,{messageIdentifier:I.messageIdentifier});this._schedule_message(pubCompMessage);break;case m.PUBCOMP:var H=this._sentMessages[I.messageIdentifier];delete this._sentMessages[I.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+I.messageIdentifier);if(this.onMessageDelivered){this.onMessageDelivered(H.payloadMessage)}break;case m.SUBACK:var H=this._sentMessages[I.messageIdentifier];if(H){if(H.timeOut){H.timeOut.cancel()}if(H.callback){H.callback()}delete this._sentMessages[I.messageIdentifier]}break;case m.UNSUBACK:var H=this._sentMessages[I.messageIdentifier];if(H){if(H.timeOut){H.timeOut.cancel()}if(H.callback){H.callback()}delete this._sentMessages[I.messageIdentifier]}break;case m.PINGRESP:this.sendPinger.reset();break;case m.DISCONNECT:this._disconnected(h.INVALID_MQTT_MESSAGE_TYPE.code,t(h.INVALID_MQTT_MESSAGE_TYPE,[I.type]));break;default:this._disconnected(h.INVALID_MQTT_MESSAGE_TYPE.code,t(h.INVALID_MQTT_MESSAGE_TYPE,[I.type]))}};u.prototype._on_socket_error=function(y){this._disconnected(h.SOCKET_ERROR.code,t(h.SOCKET_ERROR,[y.data]))};u.prototype._on_socket_close=function(){this._disconnected(h.SOCKET_CLOSE.code,t(h.SOCKET_CLOSE))};u.prototype._socket_send=function(z){if(z.type==1){var y=this._traceMask(z,"password");this._trace("Client._socket_send",y)}else{this._trace("Client._socket_send",z)}this.socket.send(z.encode());this.sendPinger.reset()};u.prototype._receivePublish=function(A){switch(A.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(A);break;case 1:var y=new p(m.PUBACK,{messageIdentifier:A.messageIdentifier});this._schedule_message(y);this._receiveMessage(A);break;case 2:this._receivedMessages[A.messageIdentifier]=A;this.store("Received:",A);var z=new p(m.PUBREC,{messageIdentifier:A.messageIdentifier});this._schedule_message(z);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}};u.prototype._receiveMessage=function(y){if(this.onMessageArrived){this.onMessageArrived(y.payloadMessage)}};u.prototype._disconnected=function(z,y){this._trace("Client._disconnected",z,y);this.sendPinger.cancel();this.receivePinger.cancel();if(this._connectTimeout){this._connectTimeout.cancel()}this._msg_queue=[];this._notify_msg_sent={};if(this.socket){this.socket.onopen=null;this.socket.onmessage=null;this.socket.onerror=null;this.socket.onclose=null;if(this.socket.readyState===1){this.socket.close()}delete this.socket}if(this.connectOptions.hosts&&this.hostIndex<this.connectOptions.hosts.length-1){this.hostIndex++;this._doConnect(this.connectOptions.hosts[this.hostIndex],this.connectOptions.ports[this.hostIndex])}else{if(z===undefined){z=h.OK.code;y=t(h.OK)}if(this.connected){this.connected=false;if(this.onConnectionLost){this.onConnectionLost({errorCode:z,errorMessage:y})}}else{if(this.connectOptions.onFailure){this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:z,errorMessage:y})}}}};u.prototype._trace=function(){if(this._traceBuffer!==null){for(var z=0,y=arguments.length;z<y;z++){if(this._traceBuffer.length==this._MAX_TRACE_ENTRIES){this._traceBuffer.shift()}if(z===0){this._traceBuffer.push(arguments[z])}else{if(typeof arguments[z]==="undefined"){this._traceBuffer.push(arguments[z])}else{this._traceBuffer.push("  "+JSON.stringify(arguments[z]))}}}}};u.prototype._traceMask=function(A,z){var B={};for(var y in A){if(A.hasOwnProperty(y)){if(y==z){B[y]="******"}else{B[y]=A[y]}}}return B};var o=function(E,C,y){if(typeof E!=="string"){throw new Error(t(h.INVALID_TYPE,[typeof E,"host"]))}if(typeof C!=="number"||C<0){throw new Error(t(h.INVALID_TYPE,[typeof C,"port"]))}var B=0;for(var D=0;D<y.length;D++){var A=y.charCodeAt(D);if(55296<=A&&A<=56319){D++}B++}if(typeof y!=="string"||B<1|B>23){throw new Error(t(h.INVALID_ARGUMENT,[y,"clientId"]))}var z=new u(E,C,y);this._getHost=function(){return z.host};this._setHost=function(){throw new Error(t(h.UNSUPPORTED_OPERATION))};this._getPort=function(){return z.port};this._setPort=function(){throw new Error(t(h.UNSUPPORTED_OPERATION))};this._getClientId=function(){return z.clientId};this._setClientId=function(){throw new Error(t(h.UNSUPPORTED_OPERATION))};this._getOnConnectionLost=function(){return z.onConnectionLost};this._setOnConnectionLost=function(F){if(typeof F==="function"){z.onConnectionLost=F}else{throw new Error(t(h.INVALID_TYPE,[typeof F,"onConnectionLost"]))}};this._getOnMessageDelivered=function(){return z.onMessageDelivered};this._setOnMessageDelivered=function(F){if(typeof F==="function"){z.onMessageDelivered=F}else{throw new Error(t(h.INVALID_TYPE,[typeof F,"onMessageDelivered"]))}};this._getOnMessageArrived=function(){return z.onMessageArrived};this._setOnMessageArrived=function(F){if(typeof F==="function"){z.onMessageArrived=F}else{throw new Error(t(h.INVALID_TYPE,[typeof F,"onMessageArrived"]))}};this.connect=function(G){G=G||{};k(G,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object"});if(G.keepAliveInterval===undefined){G.keepAliveInterval=60}if(G.willMessage){if(!(G.willMessage instanceof a)){throw new Error(t(h.INVALID_TYPE,[G.willMessage,"connectOptions.willMessage"]))}G.willMessage.stringPayload;if(typeof G.willMessage.destinationName==="undefined"){throw new Error(t(h.INVALID_TYPE,[typeof G.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}}if(typeof G.cleanSession==="undefined"){G.cleanSession=true}if(G.hosts){if(!G.ports){throw new Error(t(h.INVALID_ARGUMENT,[G.ports,"connectOptions.ports"]))}if(!(G.hosts instanceof Array)){throw new Error(t(h.INVALID_ARGUMENT,[G.hosts,"connectOptions.hosts"]))}if(!(G.ports instanceof Array)){throw new Error(t(h.INVALID_ARGUMENT,[G.ports,"connectOptions.ports"]))}if(G.hosts.length<1){throw new Error(t(h.INVALID_ARGUMENT,[G.hosts,"connectOptions.hosts"]))}if(G.hosts.length!=G.ports.length){throw new Error(t(h.INVALID_ARGUMENT,[G.ports,"connectOptions.ports"]))}for(var F=0;F<G.hosts.length;F++){if(typeof G.hosts[F]!=="string"){throw new Error(t(h.INVALID_TYPE,[typeof G.hosts[F],"connectOptions.hosts["+F+"]"]))}if(typeof G.ports[F]!=="number"||G.ports[F]<0){throw new Error(t(h.INVALID_TYPE,[typeof G.ports[F],"connectOptions.ports["+F+"]"]))}}}z.connect(G)};this.subscribe=function(G,F){if(typeof G!=="string"){throw new Error("Invalid argument:"+G)}F=F||{};k(F,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(F.timeout&&!F.onFailure){throw new Error("subscribeOptions.timeout specified with no onFailure callback.")}if(typeof F.qos!=="undefined"&&!(F.qos===0||F.qos===1||F.qos===2)){throw new Error(t(h.INVALID_ARGUMENT,[F.qos,"subscribeOptions.qos"]))}z.subscribe(G,F)};this.unsubscribe=function(G,F){if(typeof G!=="string"){throw new Error("Invalid argument:"+G)}F=F||{};k(F,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(F.timeout&&!F.onFailure){throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.")}z.unsubscribe(G,F)};this.send=function(F){if(!(F instanceof a)){throw new Error("Invalid argument:"+typeof F)}if(typeof F.destinationName==="undefined"){throw new Error("Invalid parameter Message.destinationName:"+F.destinationName)}z.send(F)};this.disconnect=function(){z.disconnect()};this.getTraceLog=function(){return z.getTraceLog()};this.startTrace=function(){z.startTrace()};this.stopTrace=function(){z.stopTrace()}};o.prototype={get host(){return this._getHost()},set host(y){this._setHost(y)},get port(){return this._getPort()},set port(y){this._setPort(y)},get clientId(){return this._getClientId()},set clientId(y){this._setClientId(y)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(y){this._setOnConnectionLost(y)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(y){this._setOnMessageDelivered(y)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(y){this._setOnMessageArrived(y)}};var a=function(z){var C;if(typeof z==="string"||z instanceof ArrayBuffer||z instanceof Int8Array||z instanceof Uint8Array||z instanceof Int16Array||z instanceof Uint16Array||z instanceof Int32Array||z instanceof Uint32Array||z instanceof Float32Array||z instanceof Float64Array){C=z}else{throw (t(h.INVALID_ARGUMENT,[z,"newPayload"]))}this._getPayloadString=function(){if(typeof C==="string"){return C}else{return l(C,0,C.length)}};this._getPayloadBytes=function(){if(typeof C==="string"){var E=new ArrayBuffer(c(C));var F=new Uint8Array(E);g(C,F,0);return F}else{return C}};var D=undefined;this._getDestinationName=function(){return D};this._setDestinationName=function(E){if(typeof E==="string"){D=E}else{throw new Error(t(h.INVALID_ARGUMENT,[E,"newDestinationName"]))}};var A=0;this._getQos=function(){return A};this._setQos=function(E){if(E===0||E===1||E===2){A=E}else{throw new Error("Invalid argument:"+E)}};var y=false;this._getRetained=function(){return y};this._setRetained=function(E){if(typeof E==="boolean"){y=E}else{throw new Error(t(h.INVALID_ARGUMENT,[E,"newRetained"]))}};var B=false;this._getDuplicate=function(){return B};this._setDuplicate=function(E){B=E}};a.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(y){this._setDestinationName(y)},get qos(){return this._getQos()},set qos(y){this._setQos(y)},get retained(){return this._getRetained()},set retained(y){this._setRetained(y)},get duplicate(){return this._getDuplicate()},set duplicate(y){this._setDuplicate(y)}};return{Client:o,Message:a}})(window);</script>
</body>
</html>